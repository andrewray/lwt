(jbuild_version 1)

;; pre-processing cppo files

(rule
 ((targets (lwt_unix.ml))
  (deps    (lwt_unix.cppo.ml))
  (action  (run ${bin:cppo} -V OCAML:${ocaml_version} ${<} -o ${@}))))

(rule
 ((targets (lwt_unix.mli))
  (deps    (lwt_unix.cppo.mli))
  (action  (run ${bin:cppo} -V OCAML:${ocaml_version} ${<} -o ${@}))))

;; lwt discover.ml

(rule
 ((targets (lwt_config.h lwt_config.ml))
  (deps (config/discover.exe))
  (action (run ${<}
    -ext-obj .o                            ;; windows ... .obj?
    -exec-name a.out                       ;; windows ... a.exe?
    -use-libev ${lib-available:conf-libev}
    -os-type Unix                          ;; ??? Win32
    -use-glib true                         ;; ??? optionally installed
    -ccomp-type cc                         ;; ??? msvc
    -use-pthread ${lib-available:threads}
    -use-unix ${lib-available:unix}        ;; but we are building for unix!
    -android-target false                  ;; presumably modified in the android repository
    -libev_default true                    ;; ??? if c library exists
  ))))

;; gen_stubs.ml

(rule
 ((targets (
    lwt_unix_job_access.c
    lwt_unix_job_chdir.c
    lwt_unix_job_chmod.c
    lwt_unix_job_chown.c
    lwt_unix_job_chroot.c
    lwt_unix_job_close.c
    lwt_unix_job_fchmod.c
    lwt_unix_job_fchown.c
    lwt_unix_job_fdatasync.c
    lwt_unix_job_fsync.c
    lwt_unix_job_ftruncate.c
    lwt_unix_job_link.c
    lwt_unix_job_lseek.c
    lwt_unix_job_mkdir.c
    lwt_unix_job_mkfifo.c
    lwt_unix_job_rename.c
    lwt_unix_job_rmdir.c
    lwt_unix_job_symlink.c
    lwt_unix_job_tcdrain.c
    lwt_unix_job_tcflow.c
    lwt_unix_job_tcflush.c
    lwt_unix_job_tcsendbreak.c
    lwt_unix_job_truncate.c
    lwt_unix_job_unlink.c
    lwt_unix_jobs_generated.ml
  ))
  (deps (stubs/gen_stubs.exe))
  (action (run ${<}))))

;; main library
;; Lwt_unix_jobs_generated and Lwt_config should be hidden

(library
 ((name lwt_unix)
  (public_name lwt.unix)
  (wrapped false)
  (libraries (lwt lwt.log unix bigarray))
  (c_names (
    lwt_unix_stubs
    lwt_libev_stubs
    lwt_process_stubs
    lwt_unix_job_access
    lwt_unix_job_chdir
    lwt_unix_job_chmod
    lwt_unix_job_chown
    lwt_unix_job_chroot
    lwt_unix_job_close
    lwt_unix_job_fchmod
    lwt_unix_job_fchown
    lwt_unix_job_fdatasync
    lwt_unix_job_fsync
    lwt_unix_job_ftruncate
    lwt_unix_job_link
    lwt_unix_job_lseek
    lwt_unix_job_mkdir
    lwt_unix_job_mkfifo
    lwt_unix_job_rename
    lwt_unix_job_rmdir
    lwt_unix_job_symlink
    lwt_unix_job_tcdrain
    lwt_unix_job_tcflow
    lwt_unix_job_tcflush
    lwt_unix_job_tcsendbreak
    lwt_unix_job_truncate
    lwt_unix_job_unlink
  )) 
  (install_c_headers (
    lwt_config
    lwt_unix
    lwt_unix_unix
    lwt_unix_windows
  ))
  (c_flags (-I.))
  (c_library_flags (-lpthread))
))

